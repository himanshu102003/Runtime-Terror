steps:
# 1) Install Python dependencies
- name: 'python:3.11'
  id: 'install-deps'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      python -m venv /workspace/venv
      source /workspace/venv/bin/activate
      pip install requests google-auth lxml

# 2) Generate AI tests
- name: 'python:3.11'
  id: 'generate-tests'
  entrypoint: 'bash'
  env:
    - 'GOOGLE_CLOUD_PROJECT=runtime-terror-473409'
  args:
    - '-c'
    - |
      source /workspace/venv/bin/activate
      cd /workspace
      python tools/vertex_generate_tests.py \
        --source_dir=src/main/java/io/github/mariazevedo88/financialjavaapi/ \
        --out_dir=src/test/java \
        --include_project_context

# 3) Verify Java version and run Maven tests
- name: 'maven:3.9.4-eclipse-temurin-11'
  id: 'verify-java'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "Java version (should be 11):"
      java -version
      echo "Maven version:"
      mvn -version

- name: 'maven:3.9.4-eclipse-temurin-11'
  id: 'run-tests'
  entrypoint: 'mvn'
  args: 
    - 'clean'
    - 'test'
    - 'jacoco:report'

# 4) Upload reports to GCS
- name: 'gcr.io/cloud-builders/gsutil'
  id: 'upload-reports'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      gsutil -m cp -r target gs://runtime-terror-logs/reports/$SHORT_SHA/
      gsutil -m cp -r src/test/java gs://runtime-terror-logs/reports/$SHORT_SHA/tests/

# 5) Check coverage
- name: 'python:3.11'
  id: 'check-coverage'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      source /workspace/venv/bin/activate
      python tools/check_coverage.py target/site/jacoco/jacoco.xml 0.40

# 6) Upload artifacts to GCS (backup)
- name: 'gcr.io/cloud-builders/gsutil'
  id: 'upload-artifacts'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "Uploading build artifacts..."
      gsutil -m cp -r target/jacoco.exec gs://runtime-terror-logs/build-artifacts/$SHORT_SHA/target/ || true
      gsutil -m cp -r target/site/jacoco gs://runtime-terror-logs/build-artifacts/$SHORT_SHA/target/site/ || true
      gsutil -m cp -r target/surefire-reports gs://runtime-terror-logs/build-artifacts/$SHORT_SHA/target/ || true
      if [ -d "src/test/java" ] && [ "$(find src/test/java -name '*.java' | wc -l)" -gt 0 ]; then
        gsutil -m cp -r src/test/java gs://runtime-terror-logs/build-artifacts/$SHORT_SHA/src/test/ || true
      else
        echo "No test files found to upload"
      fi

timeout: '1800s'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_MEDIUM'